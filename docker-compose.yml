version: "3.9"

services:
  gateway:
    build:
      context: .
      dockerfile: svc_gateway/Dockerfile
    env_file:
      - .env
    environment:
      - APP_HOST=0.0.0.0
      - APP_PORT=8000
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=${JWT_ALGORITHM}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
      - PROJECTS_SERVICE_URL=${PROJECTS_SERVICE_URL}
      - DEFECTS_SERVICE_URL=${DEFECTS_SERVICE_URL}
      - REPORTS_SERVICE_URL=${REPORTS_SERVICE_URL}
    ports:
      - "8000:8000"
    depends_on:
      - svc_auth
      - svc_projects
      - svc_defects
      - svc_reports

  svc_auth:
    build:
      context: .
      dockerfile: svc_auth/Dockerfile
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://${AUTH_DB_USER}:${AUTH_DB_PASSWORD}@${AUTH_DB_HOST}:${AUTH_DB_PORT}/${AUTH_DB_NAME}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=${JWT_ALGORITHM}
      - JWT_ACCESS_TOKEN_EXPIRE_MINUTES=${JWT_ACCESS_TOKEN_EXPIRE_MINUTES}
      - APP_HOST=0.0.0.0
      - APP_PORT=8001
    ports:
      - "8001:8001"
    depends_on:
      - auth-db

  svc_projects:
    build:
      context: .
      dockerfile: svc_projects/Dockerfile
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://${PROJECTS_DB_USER}:${PROJECTS_DB_PASSWORD}@${PROJECTS_DB_HOST}:${PROJECTS_DB_PORT}/${PROJECTS_DB_NAME}
      - APP_HOST=0.0.0.0
      - APP_PORT=8002
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
    ports:
      - "8002:8002"
    depends_on:
      - projects-db

  svc_defects:
    build:
      context: .
      dockerfile: svc_defects/Dockerfile
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://${DEFECTS_DB_USER}:${DEFECTS_DB_PASSWORD}@${DEFECTS_DB_HOST}:${DEFECTS_DB_PORT}/${DEFECTS_DB_NAME}
      - APP_HOST=0.0.0.0
      - APP_PORT=8003
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
      - PROJECTS_SERVICE_URL=${PROJECTS_SERVICE_URL}
    ports:
      - "8003:8003"
    depends_on:
      - defects-db

  svc_reports:
    build:
      context: .
      dockerfile: svc_reports/Dockerfile
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://${REPORTS_DB_USER}:${REPORTS_DB_PASSWORD}@${REPORTS_DB_HOST}:${REPORTS_DB_PORT}/${REPORTS_DB_NAME}
      - APP_HOST=0.0.0.0
      - APP_PORT=8004
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
      - PROJECTS_SERVICE_URL=${PROJECTS_SERVICE_URL}
      - DEFECTS_SERVICE_URL=${DEFECTS_SERVICE_URL}
    ports:
      - "8004:8004"
    depends_on:
      - reports-db

  auth-db:
    image: postgres:16
    environment:
      - POSTGRES_DB=${AUTH_DB_NAME}
      - POSTGRES_USER=${AUTH_DB_USER}
      - POSTGRES_PASSWORD=${AUTH_DB_PASSWORD}
    ports:
      - "5433:5432"
    volumes:
      - auth-db-data:/var/lib/postgresql/data

  projects-db:
    image: postgres:16
    environment:
      - POSTGRES_DB=${PROJECTS_DB_NAME}
      - POSTGRES_USER=${PROJECTS_DB_USER}
      - POSTGRES_PASSWORD=${PROJECTS_DB_PASSWORD}
    ports:
      - "5434:5432"
    volumes:
      - projects-db-data:/var/lib/postgresql/data

  defects-db:
    image: postgres:16
    environment:
      - POSTGRES_DB=${DEFECTS_DB_NAME}
      - POSTGRES_USER=${DEFECTS_DB_USER}
      - POSTGRES_PASSWORD=${DEFECTS_DB_PASSWORD}
    ports:
      - "5435:5432"
    volumes:
      - defects-db-data:/var/lib/postgresql/data

  reports-db:
    image: postgres:16
    environment:
      - POSTGRES_DB=${REPORTS_DB_NAME}
      - POSTGRES_USER=${REPORTS_DB_USER}
      - POSTGRES_PASSWORD=${REPORTS_DB_PASSWORD}
    ports:
      - "5436:5432"
    volumes:
      - reports-db-data:/var/lib/postgresql/data

volumes:
  auth-db-data:
  projects-db-data:
  defects-db-data:
  reports-db-data:
