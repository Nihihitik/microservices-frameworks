# TESTING GUIDE

–ü–æ–¥—Ä–æ–±–Ω—ã–π –ø–æ—à–∞–≥–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π —Ä—É—á–Ω–æ–≥–æ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ Postman –∏ pytest. –î–æ–∫—É–º–µ–Ω—Ç –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã (`svc_auth`, `svc_projects`, `svc_defects`, `svc_reports`, `svc_gateway`) –∏ –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–∏—Ç—å smoke/—Ä–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω—ã–π –ø—Ä–æ–≥–æ–Ω —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–æ–ª–µ–≤–æ–π –º–æ–¥–µ–ª–∏, –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π –∏ —Ç–∏–ø–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫.

---

## 1. –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è

| –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ | –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è | –ü—Ä–∏–º–µ—á–∞–Ω–∏—è |
|------------|-------------------|------------|
| Python | 3.11+ | –¥–ª—è –∑–∞–ø—É—Å–∫–∞ pytest |
| Docker / Docker Compose | 24.x / v2 | –¥–ª—è —ç–Ω–¥-—Ç—É-—ç–Ω–¥ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ |
| Postman | 10+ | –∏–º–ø–æ—Ä—Ç–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ |
| Make, curl (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) | latest | –±—ã—Å—Ç—Ä—ã–µ smoke-–∑–∞–ø—Ä–æ—Å—ã |

1. –°–∫–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ —Å–æ–∑–¥–∞–π—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ:
   ```bash
   git clone <repo> microservices-frameworks
   cd microservices-frameworks
   python3 -m venv .venv && source .venv/bin/activate
   pip install -r requirements-dev.txt
   ```
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ `.env.example` ‚Üí `.env` –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –∏ –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞. –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å:
   - `JWT_SECRET_KEY`
   - —Å—Ç—Ä–æ–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Postgres (`DATABASE_URL` –∏–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã `DB_*`)
   - URL –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ (–¥–ª—è —Ä–∞–±–æ—Ç—ã –≤–Ω–µ Docker –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `http://localhost:<port>`).
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É:
   ```bash
   docker-compose up --build -d
   docker-compose exec svc_auth alembic upgrade head
   docker-compose exec svc_projects alembic upgrade head
   docker-compose exec svc_defects alembic upgrade head
   docker-compose exec svc_reports alembic upgrade head
   ```
   –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ—è–≤—è—Ç—Å—è –Ω–∞ –ø–æ—Ä—Ç–∞—Ö 5433‚Äë5436, —Å–µ—Ä–≤–∏—Å—ã ‚Äî 8000‚Äë8004.

---

## 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ Postman

1. –û—Ç–∫—Ä–æ–π—Ç–µ Postman ‚Üí `Collections` ‚Üí `Import`.
2. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª `docs/postman_collection.json` (–ª–µ–∂–∏—Ç –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏) –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é **Construction Defect Management**.
3. –°–æ–∑–¥–∞–π—Ç–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ `Microservices Local` —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏:

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|-----------------------|----------|
| `gateway_url` | `http://localhost:8000` | —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ Gateway |
| `jwt_token` | *(–ø—É—Å—Ç–æ)* | —Ç–æ–∫–µ–Ω –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞ |
| `manager_id` | *(UUID –º–µ–Ω–µ–¥–∂–µ—Ä–∞)* | –Ω—É–∂–µ–Ω –¥–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤ |
| `project_id` | *(UUID –ø—Ä–æ–µ–∫—Ç–∞)* | –Ω—É–∂–µ–Ω –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –æ—Ç—á—ë—Ç–æ–≤ |
| `engineer_id` | *(UUID –∏–Ω–∂–µ–Ω–µ—Ä–∞)* | –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–µ—Ñ–µ–∫—Ç–∞ |

4. –î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Å—Ç–æ–≤ –¥–æ–±–∞–≤—å—Ç–µ Postman test script –∫ –∑–∞–ø—Ä–æ—Å—É `Auth / Login`:
   ```javascript
   pm.environment.set("jwt_token", pm.response.json().data.access_token);
   ```

---

## 3. JWT –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

1. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞** ‚Äî –∑–∞–ø—Ä–æ—Å `Auth / Register Admin`. –û—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç `data.id`.
2. **–õ–æ–≥–∏–Ω** ‚Äî –∑–∞–ø—Ä–æ—Å `Auth / Login`. Postman –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç —Ç–æ–∫–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `jwt_token`.
3. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—á—ë—Ç–∫–∏**:
   - –ò–Ω–∂–µ–Ω–µ—Ä: `role = engineer`
   - –ú–µ–Ω–µ–¥–∂–µ—Ä: `role = manager`
   - –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å: `role = supervisor`
   - –ó–∞–∫–∞–∑—á–∏–∫: `role = customer`
4. –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö `manager_id`, `engineer_id`, —Å–¥–µ–ª–∞–π—Ç–µ –∑–∞–ø—Ä–æ—Å `GET /api/v1/users?role=<role>` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–¥ –∞–¥–º–∏–Ω—Å–∫–∏–º —Ç–æ–∫–µ–Ω–æ–º).
5. JWT –¥–µ–π—Å—Ç–≤—É–µ—Ç `JWT_ACCESS_TOKEN_EXPIRE_MINUTES` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30). –ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ª–æ–≥–∏–Ω –ø–æ–≤—Ç–æ—Ä–Ω–æ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ä–µ—Ñ—Ä–µ—à-–ª–æ–≥–∏–∫—É –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Postman (pre-request script).

---

## 4. –°—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º

–ù–∏–∂–µ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∫–µ–π—Å—ã. –ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ü–µ–ª—å, —à–∞–≥–∏, –æ–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç –∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π.

### 4.1 svc_gateway (–ø–æ—Ä—Ç 8000)

| –¶–µ–ª—å | –®–∞–≥–∏ | –û–∂–∏–¥–∞–µ–º–æ | –ù–µ–≥–∞—Ç–∏–≤ |
|------|------|----------|---------|
| –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è | `GET {{gateway_url}}/api/v1/users/me` —Å –≤–∞–ª–∏–¥–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º | `success=true`, –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –∑–∞–≥–æ–ª–æ–≤–∫–∏ `X-Request-ID` | –£–¥–∞–ª–∏—Ç–µ `Authorization` ‚Üí 401 |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ retry/—Ç–∞–π–º–∞—É—Ç–æ–≤ | –í—Ä—É—á–Ω—É—é –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `svc_projects` –∏ –≤—ã–∑–æ–≤–∏—Ç–µ `GET /projects` | 503/504 —Å —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º | –í –ª–æ–≥–∞—Ö Gateway –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è warning |
| JWT ‚Üí downstream | –°–æ–∑–¥–∞–π—Ç–µ –¥–µ—Ñ–µ–∫—Ç —á–µ—Ä–µ–∑ Gateway –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ svc_defects —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `author_id` –∏–∑ —Ç–æ–∫–µ–Ω–∞ | `author_id` —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å `sub` | –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –¥—Ä—É–≥–æ–π —Ä–æ–ª–∏ ‚Üí –æ–∂–∏–¥–∞–µ–º—ã–π 403 |

### 4.2 svc_auth (–ø–æ—Ä—Ç 8001)

1. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è + –≤–∞–ª–∏–¥–∞—Ü–∏—è**  
   - POST `/api/v1/auth/register` (—Å–º. –∫–æ–ª–ª–µ–∫—Ü–∏—é).  
   - –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —Å —Ç–µ–º –∂–µ email ‚Üí `400 Email already registered`.
2. **–õ–æ–≥–∏–Ω**  
   - POST `/api/v1/auth/login` ‚Üí `data.access_token`.  
   - –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å ‚Üí `401 Incorrect email or password`.
3. **–ü—Ä–æ—Ñ–∏–ª—å**  
   - GET `/api/v1/users/me` ‚Üí —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.  
   - PATCH `/api/v1/users/me` (—Å–º–µ–Ω–∞ –∏–º–µ–Ω–∏, –ø–∞—Ä–æ–ª—è). –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–º–µ–Ω—è—Ç—å `role` ‚Üí `403`.
4. **–ê–¥–º–∏–Ω—Å–∫–∏–π —Å–ø–∏—Å–æ–∫**  
   - GET `/api/v1/users?role=engineer` (—Ç–æ–ª—å–∫–æ –¥–ª—è ADMIN/SUPERVISOR).  
   - –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –∏–Ω–∂–µ–Ω–µ—Ä–æ–º ‚Üí `403`.

### 4.3 svc_projects (–ø–æ—Ä—Ç 8002)

| –°—Ü–µ–Ω–∞—Ä–∏–π | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|
| –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ | POST `/api/v1/projects/` —Å —Ç–æ–∫–µ–Ω–æ–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞. `validate_manager_exists` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç ID –≤ svc_auth. –ü—Ä–∏ –¥—É–±–ª–∏–∫–∞—Ç–µ `code` ‚Üí 400. |
| –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ | GET `/api/v1/projects/?status=ACTIVE`. –î–ª—è SUPERVISOR/CUSTOMER –¥–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∏ –æ–∂–∏–¥–∞–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —Å–≤–æ–µ–º—É `manager_id`. |
| –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ | PATCH `/api/v1/projects/{id}` ‚Äî —Ç–æ–ª—å–∫–æ MANAGER/ADMIN. –ò–∑–º–µ–Ω–µ–Ω–∏–µ `manager_id` –¥–æ–ª–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ svc_auth. |
| –û—à–∏–±–∫–∏ | –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `project_id` ‚Üí 404; –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–æ–∫–µ–Ω–∞ ‚Üí 401. |

### 4.4 svc_defects (–ø–æ—Ä—Ç 8003)

1. **–°–æ–∑–¥–∞–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞** (ENGINEER/MANAGER/ADMIN):
   - POST `/api/v1/defects/` —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏ (`project_id`, `title`, `priority`).  
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `history` —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–ª—É—á–∏–ª–∞ –∑–∞–ø–∏—Å—å `field_name=created`.
2. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è**:
   - GET `/api/v1/defects/?priority=HIGH`.  
   - –ò–Ω–∂–µ–Ω–µ—Ä –¥–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å —Ç–æ–ª—å–∫–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–ª–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –¥–µ—Ñ–µ–∫—Ç—ã.  
   - SUPERVISOR/CUSTOMER ‚Äî —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ `author_id`).
3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ**:
   - PATCH `/api/v1/defects/{id}` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ —Å—Ç–∞—Ç—É—Å–æ–≤ (—Å–º. `check_valid_status_transition`).  
   - –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—å `status` –∏–∑ `CLOSED` ‚Üí 400.
4. **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏**:
   - POST `/api/v1/comments/`, –∑–∞—Ç–µ–º `GET /comments/defects/{id}/comments`.  
   - PATCH/DELETE –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä—É –∏–ª–∏ MANAGER/ADMIN.
5. **–í–ª–æ–∂–µ–Ω–∏—è**:
   - POST `/api/v1/attachments/` (multipart). –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 10 –ú–ë, —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ —Ç–∏–ø—ã –≤ –∫–æ–¥–µ.  
   - GET `/attachments/{id}/download` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–∏–Ω–∞—Ä–Ω—ã–π –ø–æ—Ç–æ–∫.

### 4.5 svc_reports (–ø–æ—Ä—Ç 8004)

| Endpoint | –ü—Ä–æ–≤–µ—Ä–∫–∞ | Headers/Query | –û–∂–∏–¥–∞–µ–º–æ |
|----------|----------|---------------|----------|
| `GET /api/v1/reports/summary` | –ê–≥—Ä–µ–≥–∞—Ü–∏–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º/–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º | `Authorization: Bearer {{jwt_token}}`, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ `project_id`, `status`, `priority`, `start_date`, `end_date` | JSON `DefectSummaryReport` |
| `GET /api/v1/reports/detailed` | –¢–∞–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ | —Ç–µ –∂–µ —Ñ–∏–ª—å—Ç—Ä—ã | `total_count`, –º–∞—Å—Å–∏–≤ –¥–µ—Ñ–µ–∫—Ç–æ–≤ |
| `GET /api/v1/reports/export?format=csv` | –≠–∫—Å–ø–æ—Ä—Ç | `format=csv` –∏–ª–∏ `xlsx` | —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞, ‚â§5000 —Å—Ç—Ä–æ–∫ |

–ù–µ–≥–∞—Ç–∏–≤: –∑–∞–ø—Ä–æ—Å >5000 –∑–∞–ø–∏—Å–µ–π ‚Üí 400 c –ø–æ–¥—Å–∫–∞–∑–∫–æ–π –æ–± –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–∏; —Ç–∞–π–º–∞—É—Ç svc_defects/projects ‚Üí 503.

---

## 5. –†–æ–ª–µ–≤–∞—è –º–æ–¥–µ–ª—å

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–∞–±–ª–∏—á–∫—É –Ω–∏–∂–µ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ access matrix. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–æ—Ç –∂–µ –∑–∞–ø—Ä–æ—Å –ø–æ–¥ —Ä–∞–∑–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏.

| Endpoint | ENGINEER | MANAGER | SUPERVISOR | CUSTOMER | ADMIN |
|----------|----------|---------|------------|----------|-------|
| POST `/auth/register` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| GET `/users` | ‚ùå | ‚ùå | ‚úÖ | ‚ùå | ‚úÖ |
| POST `/projects` | ‚ùå | ‚úÖ | ‚ùå | ‚ùå | ‚úÖ |
| GET `/projects` | üîπ (—Ç–æ–ª—å–∫–æ —Å–≤–æ–∏) | ‚úÖ | üîπ (—Ç–æ–ª—å–∫–æ —Å–≤–æ–∏) | üîπ (—Ç–æ–ª—å–∫–æ —Å–≤–æ–∏) | ‚úÖ |
| POST `/defects` | ‚úÖ (—Å–≤–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã) | ‚úÖ | ‚ùå | ‚ùå | ‚úÖ |
| PATCH `/defects/{id}` | üîπ (—Å–≤–æ–∏) | ‚úÖ | ‚ùå | ‚ùå | ‚úÖ |
| GET `/reports/*` | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |

–õ–µ–≥–µ–Ω–¥–∞: ‚úÖ ‚Äî –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø, ‚ùå ‚Äî –∑–∞–ø—Ä–µ—â–µ–Ω–æ, üîπ ‚Äî –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ —É—Å–ª–æ–≤–∏—è–º–∏ (–æ–ø–∏—Å–∞–Ω–æ –≤ –∫–æ–¥–µ). –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ —É–º–µ–Ω—å—à–∏—Ç–µ `JWT_ACCESS_TOKEN_EXPIRE_MINUTES` –≤ `.env` –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –ø–æ—Å–ª–µ —Ç–∞–π–º-–∞—É—Ç–∞ ‚Üí –æ–∂–∏–¥–∞–µ–º—ã–π 401.

---

## 6. –û—à–∏–±–æ—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

1. **–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω** ‚Äî –∑–∞–º–µ–Ω–∏—Ç—å –æ–¥–∏–Ω —Å–∏–º–≤–æ–ª –≤ `Authorization`. –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –¥–æ–ª–∂–Ω—ã –≤–µ—Ä–Ω—É—Ç—å `401 Invalid token`.
2. **–ù–µ—Ç –ø—Ä–∞–≤** ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—Å–∫–∏–π endpoint –ø–æ–¥ –∏–Ω–∂–µ–Ω–µ—Ä–æ–º ‚Üí `403 Access denied`.
3. **–ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç —Å –ø—É—Å—Ç—ã–º `name` ‚Üí `422` —Å –¥–µ—Ç–∞–ª—è–º–∏ `RequestValidationError`.
4. **–ù–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ä–µ—Å—É—Ä—Å** ‚Äî `GET /projects/{uuid}` —Å —Ä–∞–Ω–¥–æ–º–Ω—ã–º UUID ‚Üí `404 Project ... not found`.
5. **–ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞** ‚Äî —Å–∫—Ä–∏–ø—Ç–æ–º —Å–æ–∑–¥–∞—Ç—å >5000 –¥–µ—Ñ–µ–∫—Ç–æ–≤ –∏ –≤—ã–∑–≤–∞—Ç—å `/reports/export` ‚Üí `400 Export limit exceeded`.
6. **–¢–∞–π–º–∞—É—Ç—ã** ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å –∏ –≤—ã–∑–≤–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π endpoint: gateway –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å `503` –∏–ª–∏ `504`, –∞ –ª–æ–≥–∏ ‚Äî –∑–∞–ø–∏—Å—å —Å –ø—Ä–∏—á–∏–Ω–æ–π (—Å–º. `RequestID`).

---

## 7. Pytest

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ unit-—Ç–µ—Å—Ç—ã —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω—ã –≤ `svc_<name>/tests`. –ü–æ–∫—Ä—ã–≤–∞—é—Ç –±–∞–∑–æ–≤—ã–π CRUD, –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ —Ä–æ–ª–µ–≤—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è.

```bash
pytest svc_auth/tests -q
pytest svc_projects/tests -q
pytest svc_defects/tests -q
pytest svc_reports/tests -q
pytest svc_gateway/tests -q
```

–î–ª—è –æ–±—â–µ–≥–æ –∑–∞–ø—É—Å–∫–∞:
```bash
pytest -q
```

–°–æ–∑–¥–∞–Ω `requirements-dev.txt`, –≤–∫–ª—é—á–∞—é—â–∏–π pytest/pytest-asyncio/pytest-cov. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏–∑–º–µ—Ä—è–π—Ç–µ –ø–æ–∫—Ä—ã—Ç–∏–µ:
```bash
pytest --cov=svc_auth --cov=svc_projects --cov-report=term-missing
```

---

## 8. –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

1. **Gateway** ‚Äî `docker-compose logs -f gateway` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ü–µ–ø–æ—á–∫—É –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è –∏ `X-Request-ID`.
2. **–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö** ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–µ volume‚Äô—ã (`auth-db-data`, `projects-db-data`, ...). –ü—Ä–∏ flaky-—Ç–µ—Å—Ç–∞—Ö –æ—á–∏—Å—Ç–∏—Ç–µ `docker volume rm`.
3. **Performance** ‚Äî –∑–∞–ø—É—Å—Ç–∏—Ç–µ `hey` –∏–ª–∏ `wrk` –ø—Ä–æ—Ç–∏–≤ Gateway; —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–∞–π–º–∞—É—Ç—ã/—Ä–µ—Ç—Ä–∞–∏ –Ω–µ –æ–±–≤–∞–ª–∏–≤–∞—é—Ç —Å–µ—Ä–≤–∏—Å—ã.
4. **Graceful shutdown** ‚Äî `docker-compose down` –¥–æ–ª–∂–µ–Ω –∑–∞–∫—Ä—ã–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –±–µ–∑ stack trace –≤ –ª–æ–≥–∞—Ö.

---

## 9. Troubleshooting

| –ü—Ä–æ–±–ª–µ–º–∞ | –†–µ—à–µ–Ω–∏–µ |
|----------|---------|
| `psycopg2.OperationalError: could not connect` | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ë–î, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ `docker-compose ps`, —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø–æ—Ä—Ç –Ω–µ –∑–∞–Ω—è—Ç. |
| `JWT_SECRET_KEY mismatch` | –û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Å–µ–∫—Ä–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –≤ svc_auth, svc_gateway –∏ svc_reports (–æ–Ω–∏ –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç —Ç–æ–∫–µ–Ω). |
| `httpx.ConnectError` –≤ svc_projects/svc_defects | –ó–Ω–∞—á–∏—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Å–µ—Ä–≤–∏—Å –Ω–µ –ø–æ–¥–Ω—è—Ç –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π URL. –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ `AUTH_SERVICE_URL`, `PROJECTS_SERVICE_URL` –≤ `.env`. |
| 500 –Ω–∞ `/attachments` | –ó–∞–≥—Ä—É–∂–∞–µ–º—ã–π —Ñ–∞–π–ª >10 –ú–ë –∏–ª–∏ MIME –Ω–µ –∏–∑ whitelist. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `MAX_FILE_SIZE` –∏ `ALLOWED_CONTENT_TYPES`. |
| Postman –Ω–µ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω | –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ script –≤ –∑–∞–ø—Ä–æ—Å–µ `Auth / Login` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `pm.environment.set("jwt_token", ...)`. |

---

## 10. –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –≤ –ø—Ä–æ–¥

1. –í—Å–µ pytest –ø—Ä–æ–π–¥–µ–Ω—ã —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º ‚â•80% –≤ –Ω–æ–≤—ã—Ö –º–æ–¥—É–ª—è—Ö.
2. `docker-compose up --build` –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫, –ª–æ–≥–∏ —á–∏—Å—Ç—ã –æ—Ç `ERROR`.
3. Postman –ø—Ä–æ–≥–æ–Ω –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ –¥–ª—è –≤—Å–µ—Ö —Ä–æ–ª–µ–π, —Ç–æ–∫–µ–Ω—ã —Ä–µ–≤–æ–∫–Ω—É—Ç—ã.
4. `TESTING.md` –∏ –∫–æ–ª–ª–µ–∫—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω—ã –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω—ã –∫ —Ä–µ–ª–∏–∑–Ω–æ–º—É –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—É.
5. MIGRATION: `alembic upgrade head` –≤—ã–ø–æ–ª–Ω–µ–Ω –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –º–æ–¥–µ–ª–µ–π.

–≠—Ç–æ—Ç —á–µ–∫-–ª–∏—Å—Ç –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç, —á—Ç–æ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç –∫–∞–∫ unit-, —Ç–∞–∫ –∏ —Ä—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –∞ –∑–Ω–∞—á–∏—Ç –≥–æ—Ç–æ–≤–∞ –∫ –ø–µ—Ä–µ—Ö–æ–¥—É –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø –∞—É–¥–∏—Ç–∞/—Ä–µ–ª–∏–∑–∞.
